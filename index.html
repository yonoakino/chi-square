<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Analisis Chi-Square Interaktif</title>
    <!-- Chosen Palette: Calm Neutrals & Sage -->
    <!-- Application Structure Plan: Aplikasi ini menggunakan struktur dasbor interaktif yang berpusat pada tugas pengguna. Tujuannya adalah mengubah laporan data statis menjadi alat eksplorasi dinamis. Arsitekturnya disusun ulang menjadi Alur Kerja (Workflow): 1) Panel Input (ditempatkan di kolom utama, paling atas), 2) Tabel Crosstabulation, 3) Hasil Rinci, dan 4) Dasbor Hasil Utama (Metrik & Visualisasi) di kolom samping. Perubahan ini memprioritas input dan tinjauan data tabular sebelum menuju interpretasi dan visualisasi. -->
    <!-- Visualization & Content Choices: 
        - Laporan Info: Tabel Kontingensi 2x2. -> Goal: Memungkinkan input data. -> Viz/Metode: Tabel HTML dengan elemen input. -> Interaksi: Pembaruan real-time saat mengetik. -> Justifikasi: Cara paling intuitif untuk input data tabular. -> Metode: Vanilla JS.
        - Laporan Info: Frekuensi per kategori. -> Goal: Membandingkan proporsi secara visual. -> Viz/Metode: Grafik Batang Bertumpuk (Stacked Bar Chart). -> Interaksi: Grafik diperbarui secara dinamis, tooltip menampilkan detail. -> Justifikasi: Sangat efektif untuk menunjukkan hubungan bagian-ke-keseluruhan dan membandingkannya antar grup. -> Library: Chart.js (Canvas).
        - Laporan Info: Hasil statistik (Nilai Chi-Square, p-value, df). -> Goal: Menyajikan ringkasan hasil utama. -> Viz/Metode: Kartu metrik (Metric Cards). -> Interaksi: Nilai diperbarui secara instan. -> Justifikasi: Memberikan gambaran umum hasil terpenting dengan cepat. -> Metode: HTML/Tailwind + JS.
        - Laporan Info: P-value. -> Goal: Memberikan interpretasi yang mudah dipahami. -> Viz/Metode: Blok teks dinamis. -> Interaksi: Teks berubah (signifikan/tidak signifikan) berdasarkan ambang batas p-value. -> Justifikasi: Menerjemahkan angka statistik menjadi kesimpulan yang dapat ditindaklanjuti, sangat penting untuk pemahaman pengguna. -> Metode: Vanilla JS.
        - Laporan Info: Output statistik lengkap. -> Goal: Menyediakan data statistik formal dan rinci. -> Viz/Metode: Tabel HTML terstruktur. -> Interaksi: Tabel diperbarui secara dinamis, baris tertentu (misalnya, Uji Fisher) muncul secara kondisional. -> Justifikasi: Meniru format output perangkat lunak statistik standar (seperti SPSS), memberikan kredibilitas dan detail yang diperlukan oleh para ahli. -> Metode: Vanilla JS.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); border: 1px solid #e5e7eb; }
        /* Chart Container Responsiveness */
        .chart-container { 
            position: relative; 
            width: 100%; 
            height: 40vh; /* Tinggi relatif untuk layar kecil */
            max-height: 450px; 
            margin-left: auto; 
            margin-right: auto; 
        }
        @media (min-width: 1024px) {
            .chart-container {
                height: 24rem; /* Tinggi tetap untuk desktop */
            }
        }

        .metric-value { color: #15803d; }
        .input-style { width: 100%; text-align: right; border: 1px solid #d1d5db; border-radius: 0.25rem; padding: 0.3rem; /* Padding lebih kecil */ transition: border-color 0.2s; }
        .input-style:focus { border-color: #16a34a; outline: none; box-shadow: 0 0 0 2px rgba(22, 163, 74, 0.2); }
        .label-input-style { width: 100%; border: 1px solid #d1d5db; border-radius: 0.25rem; padding: 0.3rem; /* Padding lebih kecil */ }
        .nav-button { transition: all 0.2s; }
        .nav-button.active { background-color: #16a34a; color: white; }
        .nav-button:not(.active):hover { background-color: #f0fdf4; }
        .interpretation-box { background-color: #f0fdf4; border-left: 4px solid #22c55e; }
        
        /* Perbaikan Layout Input Variabel (Grid 3 Kolom) */
        .variable-input-grid { 
            display: grid; 
            grid-template-columns: 1fr 2fr 1.5fr; 
            gap: 0.75rem; /* Kurangi gap */
            align-items: center; 
        }

        .variable-label { font-weight: 500; font-size: 0.875rem; /* Text lebih kecil */ }
        .input-header-col-2, .input-header-col-3 { font-size: 0.75rem; /* Header lebih kecil */ }
        
        /* Layout Nama Kategori (Grid 4 Kolom) */
        .category-input-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr 1fr 1fr; 
            gap: 0.25rem; /* Kurangi gap */
            align-items: center; 
        }
        .category-row-label { font-size: 0.75rem; } /* Text paling kecil untuk label baris */

        .category-header-col-2, .category-header-col-3, .category-header-col-4 { font-size: 0.75rem; } /* Header kategori lebih kecil */
        
        .collapse-button { font-size: 0.7rem; padding: 0.15rem 0.3rem; } /* Tombol Collapse lebih kecil */
        
        .warning-low-count { background-color: #fffbeb; border-left: 4px solid #f59e0b; padding: 0.5rem; margin-top: 0.75rem; border-radius: 0.375rem; font-size: 0.75rem; } /* Text warning lebih kecil */
        .interpretation-crosstab { padding: 0.5rem; margin-top: 0.75rem; border: 1px solid #e5e7eb; border-radius: 0.375rem; background-color: #f9fafb; font-size: 0.75rem; } /* Text interpretasi lebih kecil */
        
        /* Modal Styling */
        .modal { 
            z-index: 1000; 
            display: none; 
            background-color: rgba(0, 0, 0, 0.5); 
            visibility: hidden; 
        }
        .modal[style*="display: flex"] {
            visibility: visible;
        }
        .modal-content { max-width: 400px; }
        
        /* Layout Gabung Y di sebelah Gabung X */
        .collapse-btn-group { display: flex; gap: 0.1rem; }

        /* Styling untuk Tabel Hasil (paling penting untuk kepadatan) */
        .w-full.text-sm { font-size: 0.75rem; } /* Ukuran teks tabel dikurangi */
        .w-full.text-sm th, .w-full.text-sm td {
            padding: 0.15rem 0.5rem; /* Padding vertikal sangat kecil */
            line-height: 1.2; /* Kepadatan baris ditingkatkan */
            font-size: 0.75rem;
        }

        /* Styling untuk Judul Utama */
        h1 { font-size: 2.25rem; } /* H1 sedikit dikurangi dari 4xl */
        h2 { font-size: 1.5rem; } /* H2 sedikit dikurangi dari 2xl */
        h3 { font-size: 1.1rem; } /* H3 sedikit dikurangi dari xl */

        .metric-value { font-size: 2rem; } /* Nilai metrik juga dikurangi */

        /* Raw Data Table */
        .raw-data-table { font-size: 0.75rem; }
        .raw-data-table th, .raw-data-table td {
            padding: 0.2rem 0.4rem;
        }
        
    </style>
</head>

<body class="text-slate-800">

    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">

        <header class="text-center mb-6"> <!-- Kurangi margin bawah -->
            <h1 class="4xl font-extrabold text-slate-900 tracking-tight">Dasbor Analisis Chi-Square Interaktif</h1>
            <p class="mt-1 text-base text-slate-600">Analisis hubungan antara variabel kategoris secara real-time.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6"> <!-- Kurangi gap -->

            <!-- KOLOM KIRI (BARIS 2 & 3 - Crosstab & Hasil Rinci) -->
            <div class="lg:col-span-2 space-y-6 order-2 lg:order-2"> <!-- Kurangi space-y -->
                
                 <section id="crosstab-section" class="hidden"> <!-- Tambahkan 'hidden' -->
                     <h2 class="text-2xl font-bold text-slate-900 mb-2">2. Tabel Kontingensi (Crosstabulation)</h2>
                     <div class="card overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead id="crosstab-head"></thead>
                                <tbody id="crosstab-body" class="divide-y divide-slate-200"></tbody>
                            </table>
                        </div>
                     </div>
                     <!-- Kontainer Interpretasi Crosstabulation -->
                     <div id="crosstab-interpretation-container"></div>
                 </section>
                
                 <section id="detailed-tests-section" class="hidden"> <!-- Tambahkan 'hidden' -->
                     <h2 class="text-2xl font-bold text-slate-900 mb-2">3. Hasil Uji Statistik Rinci</h2>
                     <div class="card overflow-hidden">
                         <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="px-6 py-1 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Uji Statistik</th>
                                        <th class="px-6 py-1 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Nilai</th>
                                        <th class="px-6 py-1 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">df</th>
                                        <th class="px-6 py-1 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Asymp. Sig. (2-sided)</th>
                                        <th class="px-6 py-1 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Exact Sig. (2-sided)</th>
                                    </tr>
                                </thead>
                                <tbody id="detailed-tests-body" class="bg-white divide-y divide-slate-200"></tbody>
                            </table>
                         </div>
                     </div>
                 </section>
            </div>

            <!-- KOLOM KANAN (INPUT - BARIS 1) -->
            <aside class="lg:col-span-1 order-1 lg:order-1">
                <div class="card p-4 sticky top-8"> <!-- Kurangi padding card -->
                    <h2 class="text-xl font-bold text-slate-900 mb-1">1. Panel Input Data</h2>
                    <p class="text-xs text-slate-500 mb-4">Ubah nilai frekuensi atau nama kategori di bawah ini untuk melihat semua hasil diperbarui secara otomatis.</p> <!-- Text lebih kecil -->
                    
                    <div class="space-y-3"> <!-- Kurangi space-y -->
                        <!-- Header Input Variabel -->
                        <div class="variable-input-grid">
                            <span class="variable-label"></span>
                            <span class="input-header-col-2">Nama</span>
                            <span class="input-header-col-3">Jml Kategori</span>
                        </div>
                        
                        <!-- Variabel X Row -->
                        <div class="variable-input-grid">
                            <label for="varX_name" class="variable-label self-center">Variabel X</label>
                            <input type="text" id="varX_name" value="Variabel X" class="label-input-style text-center text-xs">
                            <input type="number" id="num_categories_x" value="2" min="2" max="10" class="label-input-style text-center text-xs">
                        </div>
                        
                        <!-- Variabel Y Row -->
                        <div class="variable-input-grid">
                            <label for="varY_name" class="variable-label self-center">Variabel Y</label>
                            <input type="text" id="varY_name" value="Variabel Y" class="label-input-style text-center text-xs">
                            <input type="number" id="num_categories_y" value="2" min="2" max="10" class="label-input-style text-center text-xs">
                        </div>
                        
                        <!-- Tombol Undo dipindahkan ke sini, tetapi diurus di renderInputPanel -->
                        <!-- <div id="undo-button-container" class="pt-4"> ... </div> -->
                    </div>
                    
                    <hr class="my-4"> <!-- Kurangi margin -->
                    
                    <div id="category-names-container" class="space-y-1"></div> <!-- Kurangi space-y -->
                    
                    <!-- KOTAK BARU UNTUK PENGKODEAN -->
                    <hr class="my-4"> <!-- Kurangi margin -->
                    <h3 class="text-base font-semibold text-slate-800 mb-2">Pengkodean</h3> <!-- Judul lebih kecil -->
                    <div id="coding-panel-container" class="space-y-1"></div> <!-- Kurangi space-y -->

                    <hr class="my-4"> <!-- Kurangi margin -->

                    <h3 class="text-base font-semibold text-slate-800 mb-2">Tabel Frekuensi Observasi</h3> <!-- Judul lebih kecil -->
                    <div id="frequency-table-container"></div>
                    
                    <!-- TABEL SPREADSHEET DIHILANGKAN -->
                    
                    <!-- KOTAK BARU UNTUK DATA MENTAH -->
                    <h3 class="text-base font-semibold text-slate-800 mb-2 mt-4">Tabel Data Mentah (Kode Numerik)</h3> <!-- Judul lebih kecil -->
                    <div id="raw-data-header-container" class="flex justify-between items-center mb-1"> <!-- Kurangi margin -->
                        <p class="text-xs text-slate-500">Data acak, siap disalin ke perangkat lunak statistik.</p>
                        <button id="copy-raw-data-btn" class="px-2 py-1 text-xs font-medium text-white bg-green-600 rounded-md hover:bg-green-700 transition">Salin Data Mentah</button>
                    </div>
                    <div id="raw-data-view-container" class="card p-2 overflow-x-auto max-h-64"></div> <!-- Max-height lebih kecil -->

                </div>
            </aside>
            
            <!-- BARIS BAWAH PENUH (DASBOR ANALISIS - BARIS 4) -->
            <div class="lg:col-span-3 space-y-6 order-3 lg:order-3"> <!-- Kurangi space-y -->
                 <section id="analysis-dashboard-section" class="hidden"> <!-- Tambahkan 'hidden' -->
                     <h2 class="text-2xl font-bold text-slate-900 mb-2 mt-4">4. Dasbor Analisis & Visualisasi</h2>
                     
                     <section id="results-dashboard" class="card p-4"> <!-- Kurangi padding -->
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4"> <!-- Kurangi gap dan margin -->
                            <div class="card p-3 text-center"> <!-- Kurangi padding -->
                                <h3 class="text-xs font-medium text-slate-500 uppercase tracking-wider">Nilai Chi-Square (χ²)</h3>
                                <p id="metric-chi-square" class="metric-value text-3xl font-bold mt-1">1.283</p>
                            </div>
                            <div class="card p-3 text-center">
                                <h3 class="text-xs font-medium text-slate-500 uppercase tracking-wider">P-Value</h3>
                                <p id="metric-p-value" class="metric-value text-3xl font-bold mt-1">0.257</p>
                            </div>
                            <div class="card p-3 text-center">
                                <h3 class="text-xs font-medium text-slate-500 uppercase tracking-wider">Derajat Kebebasan (df)</h3>
                                <p id="metric-df" class="metric-value text-3xl font-bold mt-1">1</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4"> <!-- Kurangi gap -->
                            <div class="p-2"> <!-- Kurangi padding -->
                                <h3 class="text-base font-semibold text-slate-900 mb-1">Visualisasi Proporsi</h3>
                                <p class="text-xs text-slate-500 mb-2">Grafik ini menunjukkan perbandingan distribusi 'Variabel Y' di setiap kategori 'Variabel X'.</p>
                                <div class="chart-container">
                                    <canvas id="chiSquareChart"></canvas>
                                </div>
                            </div>

                            <section id="interpretation-section" class="p-3 interpretation-box flex flex-col justify-center"> <!-- Kurangi padding -->
                                <h3 class="text-base font-semibold text-green-800 mb-1">Interpretasi Hasil Utama</h3>
                                <p class="text-xs text-green-700 mb-2">Bagian ini menerjemahkan hasil statistik menjadi kesimpulan yang mudah dipahami berdasarkan ambang batas $p < 0.05$.</p>
                                <p id="interpretation-text" class="text-xs text-green-700 font-medium">Dengan tingkat signifikansi 0.05, tidak ada cukup bukti untuk menyatakan adanya hubungan statistik yang signifikan antara Variabel X dan Variabel Y (p = 0.257).</p>
                            </section>
                        </div>
                     </section>
                 </section>
            </div>


        </main>
    </div>

    <!-- Modal Penggabungan Kategori -->
    <div id="collapse-modal" class="modal fixed inset-0 flex items-center justify-center p-4">
        <div class="modal-content card p-4 w-full shadow-2xl"> <!-- Kurangi padding -->
            <h3 class="text-base font-bold text-slate-900 mb-3">Gabungkan Kategori</h3>
            <p id="modal-collapse-msg" class="text-xs text-slate-600 mb-3">Anda akan menggabungkan kategori <span class="font-bold" id="cat-to-collapse-name"></span>. Pilih kategori target:</p>
            
            <label for="target-category-select" class="block text-xs font-medium text-slate-700 mb-1">Kategori Target (Tempat Penggabungan):</label>
            <select id="target-category-select" class="label-input-style mb-4"></select>

            <div class="flex justify-end space-x-2">
                <button type="button" id="cancel-collapse" class="px-3 py-1 text-xs font-medium text-slate-700 bg-slate-100 rounded-md hover:bg-slate-200">Batal</button>
                <button type="button" id="confirm-collapse" class="px-3 py-1 text-xs font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Konfirmasi Gabung</button>
            </div>
        </div>
    </div>


    <script>
    let chiSquareChart;
    let collapseState = { axis: null, indexToCollapse: null }; // State untuk menyimpan data modal
    let stateHistory = []; // Array untuk menyimpan riwayat state

    // Fungsi untuk membuat deep copy dari objek state
    const deepCopy = (obj) => JSON.parse(JSON.stringify(obj));
    
    // Fungsi untuk menyimpan state saat ini ke history
    const saveStateToHistory = () => {
        stateHistory.push(deepCopy(state));
    };

    // Fungsi untuk memulihkan state dari history
    const undoLastCollapse = () => {
        if (stateHistory.length > 0) {
            // Ambil state sebelumnya dari tumpukan
            state = stateHistory.pop();
            
            // Perbarui input dimensi agar sesuai dengan state yang dipulihkan
            document.getElementById('num_categories_x').value = state.R;
            document.getElementById('num_categories_y').value = state.C;
            document.getElementById('varX_name').value = state.varXName;
            document.getElementById('varY_name').value = state.varYName;

            // Render ulang seluruh UI berdasarkan state yang dipulihkan
            renderInputPanel();
            renderAll();
        }
    };
    
    let state = {
        R: 2,
        C: 2,
        varXName: "Variabel X",
        varYName: "Variabel Y",
        catXNames: ["Kategori A", "Kategori B"], 
        catYNames: ["Kategori C", "Kategori D"], 
        // Tambahkan array untuk menyimpan kode numerik
        catXCodes: ["0", "1"],
        catYCodes: ["0", "1"],
        frequencies: [
            [7, 6],
            [7, 13]
        ]
    };
    
    // --- Fungsi Matematika Lanjutan untuk P-Value (Integrasi) ---

    // Fungsi Log Gamma
    const gammaLn = (n) => {
        let x = n;
        let y = x;
        let tmp = x + 5.5;
        tmp -= (x + 0.5) * Math.log(tmp);
        let ser = 1.000000000190015;
        ser += 76.18009172947146 / ++y;
        ser += -86.50532032941677 / ++y;
        ser += 24.01409824083091 / ++y;
        ser += -1.231739572450155 / ++y;
        ser += 0.1208650973866179e-2 / ++y;
        ser += -0.5395239384953e-5 / ++y;
        return -tmp + Math.log(2.5066282746310005 * ser / x);
    };

    // Fungsi Gamma Teratur Tidak Lengkap (Continuous Fraction)
    const gammaCF = (a, x) => {
        const ITMAX = 100;
        const EPS = 3.0e-7;
        let i, b, c, d, del;
        let an, h;
        
        b = x + 1.0 - a;
        c = 1.0 / EPS;
        d = 1.0 / b;
        h = d;

        for (i = 1; i <= ITMAX; i++) {
            an = -i * (i - a);
            b += 2.0;
            d = an * d + b;
            if (Math.abs(d) < EPS) d = EPS;
            c = b + an / c;
            if (Math.abs(c) < EPS) c = EPS;
            d = 1.0 / d;
            del = d * c;
            h *= del;
            if (Math.abs(del - 1.0) < EPS) break;
        }

        if (i > ITMAX) {
            console.error("A continues fraction failed");
            return NaN;
        }
        return Math.exp(-x + a * Math.log(x) - gammaLn(a)) * h;
    };
    
    // Fungsi P-Value Chi-Square (untuk df >= 1)
    const chiSquarePValue = (chi, df) => {
        if (chi < 0 || df <= 0) return 1.0;
        if (chi === 0) return 1.0;
        
        let a = df / 2.0;
        let x = chi / 2.0;
        
        // P-value adalah luasan ekor (1 - CDF)
        // Fungsi gammaCF menghitung P(a, x) = Q(a, x) = 1 - P(a, x)
        // Dimana P(a, x) adalah P(x | a), jadi CDF
        
        // Kasus spesial df=1 (digunakan untuk Continuity Correction)
        if (df === 1) {
            const z = Math.sqrt(chi);
            const erfc = (x) => {
                const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741, a4 = -1.453152027, a5 = 1.061405429;
                const p = 0.3275911;
                x = Math.abs(x);
                const t = 1.0 / (1.0 + p * x);
                const W = (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t;
                return W * Math.exp(-x * x);
            };
            return erfc(z / Math.sqrt(2));
        }

        // P-Value untuk df > 1 (menggunakan Continuous Fraction)
        return gammaCF(a, x);
    };

    // Fungsi lama untuk P-Value DF=1 (Tidak lagi digunakan secara terpisah, diintegrasikan di atas)
    const erfc = (x) => {
        const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741, a4 = -1.453152027, a5 = 1.061405429;
        const p = 0.3275911;
        x = Math.abs(x);
        const t = 1.0 / (1.0 + p * x);
        const W = (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t;
        return W * Math.exp(-x * x);
    };

    const logFactorial = (n) => {
        if (n < 0) return NaN;
        let result = 0;
        for (let i = 2; i <= n; i++) {
            result += Math.log(i);
        }
        return result;
    };

    const calculateTableProbability = (a, b, c, d) => {
        const R1 = a + b, R2 = c + d, C1 = a + c, C2 = b + d, N = a + b + c + d;
        const logP = logFactorial(R1) + logFactorial(R2) + logFactorial(C1) + logFactorial(C2) -
                     logFactorial(N) - logFactorial(a) - logFactorial(b) - logFactorial(c) - logFactorial(d);
        return Math.exp(logP);
    };

    function fisherExactTest(n11, n12, n21, n22) {
        const R1 = n11 + n12, R2 = n21 + n22, C1 = n11 + n21, N = R1 + R2;
        if (N === 0) return { twoSided: NaN };
        const minN11 = Math.max(0, R1 + C1 - N);
        const maxN11 = Math.min(R1, C1);
        const observedP = calculateTableProbability(n11, n12, n21, n22);
        let twoSidedP = 0;
        for (let k = minN11; k <= maxN11; k++) {
            const a = k, b = R1 - a, c = C1 - a, d = R2 - c;
            if (b < 0 || c < 0 || d < 0) continue;
            const Pk = calculateTableProbability(a, b, c, d);
            if (Pk <= observedP) {
                twoSidedP += Pk;
            }
        }
        return { twoSided: twoSidedP };
    };

    const calculateStatistics = () => {
        const O = state.frequencies;
        const R = state.R, C = state.C;
        const Ri = new Array(R).fill(0);
        const Cj = new Array(C).fill(0);
        let N = 0;

        for (let i = 0; i < R; i++) {
            for (let j = 0; j < C; j++) {
                Ri[i] += O[i][j];
                Cj[j] += O[i][j];
                N += O[i][j];
            }
        }

        if (N === 0) return { N: 0 };
        
        const E = Array(R).fill(0).map(() => Array(C).fill(0));
        let chiSquare = 0, ccChiSquare = 0, likelihoodRatio = 0;
        let lowExpectedCount = 0; // Tambahkan penghitung Low Expected Count
        let minExpectedCount = Infinity;
        let maxObserved = -Infinity;
        let maxObservedLoc = {i: -1, j: -1};

        for (let i = 0; i < R; i++) {
            for (let j = 0; j < C; j++) {
                E[i][j] = (Ri[i] * Cj[j]) / N;
                
                // Cek Frekuensi Harapan Rendah
                if (E[i][j] < 5) {
                    lowExpectedCount++;
                }
                if (E[i][j] < minExpectedCount) {
                    minExpectedCount = E[i][j];
                }
                
                // Cek Frekuensi Observasi Tertinggi
                if (O[i][j] > maxObserved) {
                    maxObserved = O[i][j];
                    maxObservedLoc = {i: i, j: j};
                }


                if (E[i][j] > 0) {
                    const diff = O[i][j] - E[i][j];
                    chiSquare += (diff * diff) / E[i][j];
                    
                    // Likelihood Ratio (G-Test)
                    if (O[i][j] > 0) {
                        likelihoodRatio += O[i][j] * Math.log(O[i][j] / E[i][j]);
                    }
                    
                    if (R === 2 && C === 2) {
                        const diffCC = Math.abs(diff) - 0.5;
                        if (diffCC > 0) {
                             ccChiSquare += (diffCC * diffCC) / E[i][j];
                        }
                    }
                }
            }
        }
        
        likelihoodRatio *= 2; // G = 2 * sum(O * ln(O/E))
        
        const df = (R - 1) * (C - 1);
        const pValue = chiSquarePValue(chiSquare, df);
        const ccPValue = (df === 1) ? chiSquarePValue(ccChiSquare, 1) : NaN;
        const lrPValue = chiSquarePValue(likelihoodRatio, df);
        
        const fisherP = (R === 2 && C === 2) ? fisherExactTest(O[0][0], O[0][1], O[1][0], O[1][1]) : { twoSided: NaN };

        // Tambahkan statistik untuk interpretasi crosstab
        const totalCells = R * C;
        const percentLowExpected = (lowExpectedCount / totalCells) * 100;
        const maxObservedPercent = (maxObserved / N) * 100;
        
        return { N, O, E, Ri, Cj, chiSquare, ccChiSquare, likelihoodRatio, df, pValue, ccPValue, lrPValue, fisherP, 
                 lowExpectedCount, totalCells, percentLowExpected, minExpectedCount, 
                 maxObserved, maxObservedLoc, maxObservedPercent };
    };

    const formatPValue = (p) => {
        if (isNaN(p)) return '-';
        // PERBAIKAN: Selalu tampilkan '0' di depan titik desimal (kecuali untuk p < 0.001)
        if (p < 0.001) return '0.000'; 
        return p.toFixed(3); // Menghilangkan replace(/^0\./, '0.') karena toFixed(3) sudah menghasilkan "0.xxx"
    };

    const handleDimensionChange = () => {
        // 1. Baca dimensi baru
        const numX = document.getElementById('num_categories_x');
        const numY = document.getElementById('num_categories_y');

        const newR = parseInt(numX.value) || 2;
        const newC = parseInt(numY.value) || 2;
        
        // Simpan state lama
        const oldR = state.R;
        const oldC = state.C;
        
        // 2. Update state dimensi baru (dengan clamp)
        state.R = Math.max(2, Math.min(10, newR));
        state.C = Math.max(2, Math.min(10, newC));
        numX.value = state.R; // Update input field jika nilai dikunci (clamped)
        numY.value = state.C;

        // 3. Preserve data and resize arrays
        state.varXName = document.getElementById('varX_name').value;
        state.varYName = document.getElementById('varY_name').value;
        
        // Baca semua input yang ada sebelum dirender ulang untuk memuat data terkini
        let currentCatXNames = [];
        let currentCatYNames = [];
        let currentCatXCodes = [];
        let currentCatYCodes = [];
        
        for (let i = 0; i < oldR; i++) {
            const elXName = document.getElementById(`catX_name_${i}`);
            if (elXName) currentCatXNames[i] = elXName.value;
            const elXCode = document.getElementById(`catX_code_${i}`);
            if (elXCode) currentCatXCodes[i] = elXCode.value;

            const elYName = document.getElementById(`catY_name_${i}`);
            if (elYName) currentCatYNames[i] = elYName.value;
            const elYCode = document.getElementById(`catY_code_${i}`);
            if (elYCode) currentCatYCodes[i] = elYCode.value;
        }

        // Resize dan isi nama default, mempertahankan nama lama
        state.catXNames = Array(state.R).fill().map((_, i) => {
             if (i < oldR) return currentCatXNames[i];
             return i === 0 ? "Kategori A" : i === 1 ? "Kategori B" : `Kategori ${i+1}`;
        });
        state.catYNames = Array(state.C).fill().map((_, j) => {
             if (j < oldC) return currentCatYNames[j];
             return j === 0 ? "Kategori C" : j === 1 ? "Kategori D" : `Kategori ${j+1}`;
        });
        
        // Resize dan isi kode default (0, 1, 2, ...)
        state.catXCodes = Array(state.R).fill().map((_, i) => {
             if (i < oldR) return currentCatXCodes[i] || String(i);
             return String(i);
        });
        state.catYCodes = Array(state.C).fill().map((_, j) => {
             if (j < oldC) return currentCatYCodes[j] || String(j);
             return String(j);
        });


        // Resize dan isi frekuensi default, mempertahankan data lama
        const newFrequencies = Array(state.R).fill().map(() => Array(state.C).fill(0));
        for (let i = 0; i < state.R; i++) {
            for (let j = 0; j < state.C; j++) {
                // Pertahankan data lama
                if (i < oldR && j < oldC) {
                    const el = document.getElementById(`freq_${i}_${j}`);
                    newFrequencies[i][j] = parseInt(el?.value) || state.frequencies[i][j] || 0;
                } else {
                    newFrequencies[i][j] = 0;
                }
            }
        }
        state.frequencies = newFrequencies;
        
        // 4. Render input panel segera untuk merefleksikan jumlah kategori baru
        renderInputPanel(); 
        
        // 5. Lanjutkan ke flow update hasil (yang sekarang dilakukan di renderAll)
        renderAll();
    };

    const handleInputChange = (event) => {
        // Hanya baca nama variabel, nama kategori, dan frekuensi dari DOM yang sudah ada.
        state.varXName = document.getElementById('varX_name').value;
        state.varYName = document.getElementById('varY_name').value;
        
        // Baca nama kategori dan kode
        for (let i = 0; i < state.R; i++) {
            const elXName = document.getElementById(`catX_name_${i}`);
            if(elXName) state.catXNames[i] = elXName.value;
            const elXCode = document.getElementById(`catX_code_${i}`);
            if(elXCode) state.catXCodes[i] = elXCode.value;
        }
        for (let j = 0; j < state.C; j++) {
            const elYName = document.getElementById(`catY_name_${j}`);
            if(elYName) state.catYNames[j] = elYName.value;
            const elYCode = document.getElementById(`catY_code_${j}`);
            if(elYCode) state.catYCodes[j] = elYCode.value;
        }
        
        // Baca frekuensi
        for (let i = 0; i < state.R; i++) {
            for (let j = 0; j < state.C; j++) {
                const el = document.getElementById(`freq_${i}_${j}`);
                if(el) state.frequencies[i][j] = parseInt(el.value) || 0;
            }
        }
        
        const changedId = event.target.id;

        // Jika yang diubah adalah Nama Variabel Utama, render ulang seluruh panel input (untuk header)
        if (changedId === 'varX_name' || changedId === 'varY_name') {
             renderInputPanel();
        } else {
             // Jika yang diubah adalah Nama Kategori, Kode, atau Frekuensi,
             // PERBAIKAN: Hanya perbarui header variabel di panel input dan render ulang tabel frekuensi
             document.querySelector('#category-names-container .category-header-col-2').textContent = state.varXName;
             document.querySelector('#category-names-container .category-header-col-3').textContent = state.varYName;
             
             // Perbarui header panel pengkodean juga
             const codingHeaderX = document.querySelector('#coding-panel-container .coding-header-col-2');
             if(codingHeaderX) codingHeaderX.textContent = state.varXName;
             const codingHeaderY = document.querySelector('#coding-panel-container .coding-header-col-3');
             if(codingHeaderY) codingHeaderY.textContent = state.varYName;
             
             // Panggil fungsi rendering khusus untuk Tabel Frekuensi agar nama kategori di kolom dan baris di tabel frekuensi terupdate
             renderFrequencyTableOnly();
        }

        renderAll();
    };
    
    // FUNGSI BARU: Hanya merender Tabel Frekuensi Observasi
    const renderFrequencyTableOnly = () => {
        const freqContainer = document.getElementById('frequency-table-container');
        
        // Render tabel frekuensi
        let freqHtml = '<table class="w-full text-sm">';
        freqHtml += `<thead><tr><th class="py-2"></th>`;
        // Header kolom (Nama Kategori Y)
        state.catYNames.forEach(name => {
            freqHtml += `<th class="font-medium text-slate-600 py-2">${name}</th>`;
        });
        freqHtml += `</tr></thead><tbody>`;
        for (let i = 0; i < state.R; i++) {
            // Label baris (Nama Kategori X)
            freqHtml += `<tr class="border-t border-slate-200"><td class="font-medium text-slate-600 py-2 pr-2">${state.catXNames[i]}</td>`;
            for (let j = 0; j < state.C; j++) {
                // Input Frekuensi (mempertahankan value lama)
                freqHtml += `<td class="p-1"><input type="number" id="freq_${i}_${j}" value="${state.frequencies[i][j]}" min="0" class="input-style"></td>`;
            }
            freqHtml += `</tr>`;
        }
        freqHtml += `</tbody></table>`;
        freqContainer.innerHTML = freqHtml;
        
        // Pasang kembali listener ke input frekuensi yang BARU dibuat
        document.querySelectorAll('#frequency-table-container input').forEach(el => el.addEventListener('input', handleInputChange));
        
        // Perbarui tampilan data mentah
        renderRawDataView(); 
    }
    
    // FUNGSI BARU: Merender Panel Pengkodean
    const renderCodingPanel = () => {
        const codingContainer = document.getElementById('coding-panel-container');
        
        let codingHtml = `<div class="category-input-grid mb-1">
            <span class="category-row-label"></span>
            <span class="category-header-col-2 coding-header-col-2">${state.varXName}</span>
            <span class="category-header-col-3 coding-header-col-3">${state.varYName}</span>
            <span class="category-header-col-4">Kode</span>
        </div>`;
        
        const maxDim = Math.max(state.R, state.C);
        
        for(let k = 0; k < maxDim; k++) {
             codingHtml += `<div class="category-input-grid">`;
             codingHtml += `<label class="category-row-label self-center">Kategori ${k+1}</label>`; 

             // Input Kode X
             if (k < state.R) {
                 codingHtml += `<div><input type="text" id="catX_code_${k}" value="${state.catXCodes[k]}" class="label-input-style text-center text-xs"></div>`;
             } else {
                 codingHtml += `<div></div>`;
             }
             
             // Input Kode Y
             if (k < state.C) {
                 codingHtml += `<div><input type="text" id="catY_code_${k}" value="${state.catYCodes[k]}" class="label-input-style text-center text-xs"></div>`;
             } else {
                 codingHtml += `<div></div>`;
             }
             
             // Kode Numerik (Label)
             codingHtml += `<div><span class="font-medium text-slate-700 text-xs">Kode: ${k}</span></div>`;
             
             codingHtml += `</div>`;
        }
        
        codingContainer.innerHTML = codingHtml;

        // Pasang listener untuk input Kode
        document.querySelectorAll('#coding-panel-container input').forEach(el => el.addEventListener('input', handleInputChange));

    }


    // FUNGSI BARU: Mengacak array menggunakan Fisher-Yates Shuffle
    const shuffleArray = (array) => {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }
    
    // FUNGSI BARU: Menyalin data mentah ke clipboard
    const copyRawData = () => {
        const rawObservations = [];
        const R = state.R, C = state.C;
        
        // Kumpulkan semua observasi menjadi satu array
        for (let i = 0; i < R; i++) {
            for (let j = 0; j < C; j++) {
                const count = state.frequencies[i][j];
                const codeX = state.catXCodes[i];
                const codeY = state.catYCodes[j];

                for (let k = 0; k < count; k++) {
                    rawObservations.push(`${codeX}\t${codeY}`);
                }
            }
        }
        
        // Acak urutan observasi
        shuffleArray(rawObservations);
        
        // Gabungkan dengan newline
        const dataToCopy = rawObservations.join('\n');

        // Salin ke clipboard
        const tempTextArea = document.createElement('textarea');
        tempTextArea.value = dataToCopy;
        document.body.appendChild(tempTextArea);
        tempTextArea.select();
        document.execCommand('copy');
        document.body.removeChild(tempTextArea);

        // Feedback visual
        const button = document.getElementById('copy-raw-data-btn');
        const originalText = button.textContent;
        button.textContent = 'Data Tersalin!';
        setTimeout(() => {
            button.textContent = originalText;
        }, 1500);
    }


    // FUNGSI BARU: Merender Tabel Data Mentah (Raw Data) secara acak menggunakan kode
    const renderRawDataView = () => {
        const rawDataContainer = document.getElementById('raw-data-view-container');
        // PERHATIAN: Header Tabel di sini masih perlu agar pengguna tahu kolom mana yang mana
        let rawDataHtml = `<table class="raw-data-table w-full"><thead><tr>
                            <th class="bg-slate-200">${state.varXName}</th>
                            <th class="bg-slate-200">${state.varYName}</th>
                         </tr></thead><tbody>`;

        const rawObservations = [];
        let totalCount = 0;
        const R = state.R, C = state.C;

        // 1. Kumpulkan semua observasi kode numerik
        for (let i = 0; i < R; i++) {
            for (let j = 0; j < C; j++) {
                const count = state.frequencies[i][j];
                const codeX = state.catXCodes[i];
                const codeY = state.catYCodes[j];
                totalCount += count;

                for (let k = 0; k < count; k++) {
                    rawObservations.push({ x: codeX, y: codeY });
                }
            }
        }
        
        // 2. Acak urutan observasi (Fisher-Yates Shuffle)
        shuffleArray(rawObservations);

        // 3. Render array yang sudah diacak
        rawObservations.forEach(obs => {
            rawDataHtml += `<tr><td>${obs.x}</td><td>${obs.y}</td></tr>`;
        });
        
        if (totalCount === 0) {
             rawDataHtml += `<tr><td colspan="2" class="text-center text-slate-500">Masukkan frekuensi observasi untuk membuat data mentah.</td></tr>`;
        }

        rawDataHtml += `</tbody></table>`;
        rawDataContainer.innerHTML = rawDataHtml;
    }

    // Fungsi yang dipanggil saat tombol Gabung diklik
    const openCollapseModal = (axis, indexToCollapse) => {
        const modal = document.getElementById('collapse-modal');
        const select = document.getElementById('target-category-select');
        const msgSpan = document.getElementById('cat-to-collapse-name');

        // Simpan state sementara
        collapseState.axis = axis;
        collapseState.indexToCollapse = indexToCollapse;

        const targetCategories = axis === 'R' ? state.catXNames : state.catYNames;
        const nameToCollapse = targetCategories[indexToCollapse];
        
        msgSpan.textContent = `'${nameToCollapse}'`;
        select.innerHTML = ''; // Kosongkan pilihan lama

        // Isi dropdown dengan kategori target yang valid (bukan kategori itu sendiri)
        let optionsHtml = '<option value="" disabled selected>Pilih Kategori...</option>';
        targetCategories.forEach((name, index) => {
            if (index !== indexToCollapse) {
                optionsHtml += `<option value="${index}">${name} (Kategori ${index + 1})</option>`;
            }
        });
        select.innerHTML = optionsHtml;

        // Tampilkan modal
        modal.style.display = 'flex';
    };

    // Fungsi yang dipanggil saat Konfirmasi Gabung di Modal
    const confirmCollapse = () => {
        const select = document.getElementById('target-category-select');
        const targetIndex = parseInt(select.value);

        if (isNaN(targetIndex)) {
            // Mengganti alert dengan pemberitahuan di konsol
            console.error("Pilihan kategori target tidak valid.");
            return;
        }
        
        const { axis, indexToCollapse } = collapseState;

        // Lakukan Penggabungan
        performCollapse(axis, indexToCollapse, targetIndex);

        // Tutup modal
        document.getElementById('collapse-modal').style.display = 'none';
    };

    const performCollapse = (axis, indexToCollapse, targetIndex) => {
        // 0. Simpan state sebelum penggabungan
        saveStateToHistory();
        
        // 1. Pastikan frekuensi sudah terbaca sebelum operasi penggabungan
        handleInputChange({target: {}});

        if (axis === 'R') { // Menggabungkan Baris (Variabel X)
            if (state.R <= 2) return;
            
            // Gabungkan frekuensi
            for (let j = 0; j < state.C; j++) {
                state.frequencies[targetIndex][j] += state.frequencies[indexToCollapse][j];
            }
            
            // Hapus baris yang digabungkan dari state
            state.frequencies.splice(indexToCollapse, 1);
            
            // Gabungkan nama kategori
            state.catXNames[targetIndex] += `/${state.catXNames[indexToCollapse]}`;
            state.catXNames.splice(indexToCollapse, 1);
            
            // Hapus kode yang digabungkan (kode baru akan tetap berada di targetIndex)
            state.catXCodes.splice(indexToCollapse, 1);


            // Update dimensi
            state.R--;
            document.getElementById('num_categories_x').value = state.R;

        } else if (axis === 'C') { // Menggabungkan Kolom (Variabel Y)
            if (state.C <= 2) return;

            // Gabungkan frekuensi dan hapus kolom yang digabungkan dari semua baris
            for (let i = 0; i < state.R; i++) {
                state.frequencies[i][targetIndex] += state.frequencies[i][indexToCollapse];
                state.frequencies[i].splice(indexToCollapse, 1);
            }

            // Gabungkan nama kategori
            state.catYNames[targetIndex] += `/${state.catYNames[indexToCollapse]}`;
            state.catYNames.splice(indexToCollapse, 1);
            
            // Hapus kode yang digabungkan
            state.catYCodes.splice(indexToCollapse, 1);

            // Update dimensi
            state.C--;
            document.getElementById('num_categories_y').value = state.C;
        }

        // 3. Render ulang semua
        renderInputPanel();
        renderAll();
    };

    const setupListeners = () => {
        // Listener yang memicu perubahan dimensi (struktur DOM)
        document.getElementById('num_categories_x').addEventListener('change', handleDimensionChange);
        document.getElementById('num_categories_y').addEventListener('change', handleDimensionChange);
        
        // Listener untuk perubahan nama variabel (tidak mengubah struktur DOM, hanya memicu update)
        document.getElementById('varX_name').addEventListener('input', handleInputChange);
        document.getElementById('varY_name').addEventListener('input', handleInputChange);
        
        // Listener untuk Tombol Copy
        document.getElementById('copy-raw-data-btn').addEventListener('click', copyRawData);
        
        // Listener untuk Modal
        document.getElementById('confirm-collapse').addEventListener('click', confirmCollapse);
        document.getElementById('cancel-collapse').addEventListener('click', () => {
            document.getElementById('collapse-modal').style.display = 'none';
        });
    };

    const renderInputPanel = () => {
        const catContainer = document.getElementById('category-names-container');
        const codingContainer = document.getElementById('coding-panel-container');

        // Render input nama kategori
        let catHtml = `<h3 class="text-md font-semibold text-slate-800 mb-1">Nama Kategori</h3>`;
        
        // Header Nama Kategori
        catHtml += `<div class="category-input-grid mb-1">`;
        catHtml += `<span class="category-row-label"></span>`;
        catHtml += `<span class="category-header-col-2">${state.varXName}</span>`;
        catHtml += `<span class="category-header-col-3">${state.varYName}</span>`;
        catHtml += `<span class="category-header-col-4" id="collapse-header">Gabungkan</span>`; // Tambahkan ID untuk header Gabungkan
        catHtml += `</div>`;
        
        // Cek apakah ada riwayat undo
        const hasHistory = stateHistory.length > 0;
        
        // Baris Input Kategori
        for (let i = 0; i < state.R; i++) {
            catHtml += `<div class="category-input-grid">`;
            // Label Baris (Kategori 1, Kategori 2, dst.)
            catHtml += `<label class="category-row-label self-center">Kategori ${i+1}</label>`; 
            
            // Input Variabel X (Nama Kategori X)
            catHtml += `<div><input type="text" id="catX_name_${i}" value="${state.catXNames[i]}" class="label-input-style text-center text-xs"></div>`;
            
            // Input Variabel Y (Nama Kategori Y)
            if (i < state.C) {
                catHtml += `<div><input type="text" id="catY_name_${i}" value="${state.catYNames[i]}" class="label-input-style text-center text-xs"></div>`;
            } else {
                catHtml += `<div></div>`;
            }

            // Kolom Gabungkan (Baris) - Sekarang Gabung X dan Gabung Y ada di sini
            catHtml += `<div class="flex items-center space-x-1 collapse-btn-group">`;
            
            // Tombol Gabung X
            if (state.R > 2) {
                catHtml += `<button type="button" data-axis="R" data-index="${i}" class="collapse-button bg-red-100 text-red-700 hover:bg-red-200" title="Gabungkan baris ini dengan baris lain">Gabung X</button>`;
            } 
            
            // Tombol Gabung Y (Hanya jika ada kategori Y di baris ini)
            if (state.C > 2 && i < state.C) { 
                catHtml += `<button type="button" data-axis="C" data-index="${i}" class="collapse-button bg-blue-100 text-blue-700 hover:bg-blue-200" title="Gabungkan kolom ini dengan kolom lain">Gabung Y</button>`;
            }
            
            if (state.R <= 2 && (state.C <= 2 || i >= state.C)) {
                 catHtml += `<span>-</span>`;
            }

            catHtml += `</div>`;


            catHtml += `</div>`;
        }
        
        // Logika tambahan untuk Gabung Y jika C > R (karena kita membatasi loop utama berdasarkan R)
        if (state.C > state.R) {
            for (let j = state.R; j < state.C; j++) {
                catHtml += `<div class="category-input-grid">`;
                // Label Baris (Kategori R+1, dst.)
                catHtml += `<label class="category-row-label self-center">Kategori ${j+1}</label>`; 
                
                // Input X Kosong
                catHtml += `<div></div>`;
                
                // Input Variabel Y (Nama Kategori Y)
                catHtml += `<div><input type="text" id="catY_name_${j}" value="${state.catYNames[j]}" class="label-input-style text-center text-xs"></div>`;

                // Kolom Gabungkan (Baris)
                catHtml += `<div class="flex items-center space-x-1 collapse-btn-group">`;
                if (state.C > 2) {
                     // Tombol gabung Y untuk kategori yang tersisa
                     catHtml += `<button type="button" data-axis="C" data-index="${j}" class="collapse-button bg-blue-100 text-blue-700 hover:bg-blue-200" title="Gabungkan kolom ini dengan kolom lain">Gabung Y</button>`;
                } else {
                     catHtml += `<span>-</span>`;
                }
                catHtml += `</div>`;

                catHtml += `</div>`;
            }
        }
        
        catContainer.innerHTML = catHtml;
        
        // --- LOGIKA TOMBOL UNDO GLOBAL (SETELAH KATEGORI DIRENDER) ---
        const collapseHeader = document.getElementById('collapse-header');
        
        if (hasHistory) {
            // Tampilkan tombol UNDO di header kolom 'Gabungkan'
            collapseHeader.innerHTML = `<button type="button" id="undo-global-btn" class="collapse-button bg-slate-300 text-slate-800 hover:bg-slate-400 font-bold w-full" title="Batalkan penggabungan terakhir">Undo</button>`;
            document.getElementById('undo-global-btn').addEventListener('click', undoLastCollapse);
        } else {
            collapseHeader.textContent = 'Gabungkan';
        }
        // --- AKHIR LOGIKA UNDO GLOBAL ---
        
        
        // Pasang listener untuk Gabungkan Kategori (menggunakan Modal)
        document.querySelectorAll('.collapse-button').forEach(btn => {
            btn.addEventListener('click', (e) => {
                // Abaikan tombol UNDO yang diurus secara terpisah di atas
                if (e.target.id === 'undo-global-btn') return;
                
                const axis = e.target.getAttribute('data-axis');
                const indexToCollapse = parseInt(e.target.getAttribute('data-index'));

                let targetCategories = axis === 'R' ? state.catXNames : state.catYNames;
                
                if (targetCategories.length <= 2) {
                     alert("Tidak bisa menggabungkan. Minimal kategori adalah 2.");
                     return;
                }
                
                openCollapseModal(axis, indexToCollapse);
            });
        });


        // Panggil renderCodingPanel dan renderFrequencyTableOnly
        renderCodingPanel();
        renderFrequencyTableOnly();

        // Tambahkan listener untuk input kategori yang BARU dibuat (input Frekuensi dipasang di renderFrequencyTableOnly)
        document.querySelectorAll('#category-names-container input').forEach(el => el.addEventListener('input', handleInputChange));
    };
    
    // FUNGSI BARU: Render Interpretasi Crosstab
    const renderCrosstabInterpretation = (stats) => {
        const container = document.getElementById('crosstab-interpretation-container');
        if (!stats || stats.N === 0) {
            container.innerHTML = '';
            return;
        }

        let html = '';
        
        // --- 1. Interpretasi Observasi Tertinggi ---
        const maxObservedText = `Terdapat ${stats.N} kasus valid. Frekuensi observasi tertinggi adalah **${stats.maxObserved}** (${stats.maxObservedPercent.toFixed(1)}% dari total) yang terletak pada kombinasi ${state.varXName}: **${state.catXNames[stats.maxObservedLoc.i]}** dan ${state.varYName}: **${state.catYNames[stats.maxObservedLoc.j]}**.`;

        html += `<div class="interpretation-crosstab">
                    <h3 class="font-bold text-slate-800 mb-1">Interpretasi Frekuensi Observasi</h3>
                    <p class="text-xs text-slate-700">${maxObservedText}</p>
                 </div>`;
        
        // --- 2. Peringatan Frekuensi Harapan Rendah ---
        if (stats.percentLowExpected > 0) {
            let warningText = `Peringatan: ${stats.lowExpectedCount} sel (${stats.percentLowExpected.toFixed(1)}%) memiliki frekuensi harapan (Expected Count) kurang dari 5.`;

            if (stats.percentLowExpected > 20) {
                warningText += ` Karena persentase ini melebihi 20%, hasil Uji Chi-Square Pearson mungkin **tidak valid** untuk tabel $R \\times C$ ini. Anda disarankan untuk merujuk pada **Uji Likelihood Ratio** atau mempertimbangkan penggabungan kategori.`;
                if (stats.R === 2 && stats.C === 2) {
                    warningText = `Karena persentase ini melebihi 20%, hasil Uji Chi-Square Pearson mungkin **tidak valid**. Anda harus mengacu pada **Fisher's Exact Test** atau **Continuity Correction**.`;
                }
            } else if (stats.percentLowExpected > 0) {
                 warningText += ` Pastikan setiap sel memiliki nilai harapan (Expected Count) minimal ${stats.minExpectedCount.toFixed(2)}.`;
            }
            
            html += `<div class="warning-low-count text-xs">
                        <p class="font-bold text-yellow-800">PERHATIAN ASUMSI:</p>
                        <p class="text-yellow-700">${warningText}</p>
                        ${(state.R > 2 || state.C > 2) ? `<p class="mt-1 text-yellow-700 font-medium">Anda dapat menggunakan fitur **Gabungkan Kategori** di Panel Input untuk memperbaiki pelanggaran asumsi ini.</p>` : ''}
                    </div>`;
        } else {
             html += `<p class="mt-2 text-xs text-green-700 font-medium">Asumsi frekuensi harapan terpenuhi (semua sel memiliki Expected Count $\\geq 5$). Uji Chi-Square Pearson valid.</p>`;
        }

        container.innerHTML = html;
    };
    
    const renderResults = (stats) => {
        // Logika inti untuk menampilkan atau menyembunyikan bagian hasil
        const sections = [
            document.getElementById('crosstab-section'), 
            document.getElementById('detailed-tests-section'), 
            document.getElementById('analysis-dashboard-section')
        ];

        if (!stats || stats.N === 0) {
            // Sembunyikan semua hasil jika N=0
            sections.forEach(sec => sec.classList.add('hidden'));

            // Reset metrik
            document.getElementById('metric-chi-square').textContent = '-';
            document.getElementById('metric-p-value').textContent = '-';
            document.getElementById('metric-df').textContent = '-';
            return;
        }

        // Tampilkan semua hasil jika N > 0
        sections.forEach(sec => sec.classList.remove('hidden'));

        document.getElementById('metric-chi-square').textContent = stats.chiSquare.toFixed(3);
        document.getElementById('metric-p-value').textContent = formatPValue(stats.pValue);
        document.getElementById('metric-df').textContent = stats.df;

        const p = stats.pValue;
        const interpText = document.getElementById('interpretation-text');
        
        const pValueText = isNaN(p) ? 'P-Value tidak dapat dihitung' : `p = ${formatPValue(p)}`;

        if (stats.df === 0) {
            interpText.textContent = `Derajat kebebasan (df) adalah 0. Chi-Square tidak dapat dihitung.`;
            interpText.parentElement.classList.remove('bg-red-50', 'border-red-500', 'bg-green-50', 'border-green-500');
            interpText.parentElement.classList.add('bg-slate-100', 'border-slate-400');
        } else if (isNaN(p)) {
             interpText.textContent = `Terjadi kesalahan saat menghitung P-Value Chi-Square. Pastikan data frekuensi valid.`;
             interpText.parentElement.classList.remove('bg-red-50', 'border-red-500', 'bg-green-50', 'border-green-500');
             interpText.parentElement.classList.add('bg-slate-100', 'border-slate-400');
        } else if (p < 0.05) {
            interpText.parentElement.classList.remove('bg-green-50', 'border-green-500', 'bg-slate-100', 'border-slate-400');
            interpText.parentElement.classList.add('bg-red-50', 'border-red-500');
            interpText.innerHTML = `<span class="font-bold">Hasil Signifikan:</span> Dengan tingkat signifikansi 0.05, terdapat bukti yang cukup untuk menyatakan adanya hubungan statistik yang signifikan antara ${state.varXName} dan ${state.varYName} (${pValueText}).`;
        } else {
            interpText.parentElement.classList.remove('bg-red-50', 'border-red-500', 'bg-green-50', 'border-green-500');
            interpText.parentElement.classList.add('bg-green-50', 'border-green-500');
            interpText.innerHTML = `<span class="font-bold">Hasil Tidak Signifikan:</span> Dengan tingkat signifikansi 0.05, tidak ada cukup bukti untuk menyatakan adanya hubungan statistik yang signifikan antara ${state.varXName} dan ${state.varYName} (${pValueText}).`;
        }
    };
    
    const renderCrosstab = (stats) => {
        const head = document.getElementById('crosstab-head');
        const body = document.getElementById('crosstab-body');
        if (!stats || stats.N === 0) { head.innerHTML = ''; body.innerHTML = ''; return; }

        let headHtml = `<tr class="bg-slate-50"><th rowspan="2" class="px-6 py-1 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">${state.varXName}</th><th rowspan="2" class="px-6 py-1 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Ukuran</th><th colspan="${state.C}" class="px-6 py-1 text-center text-xs font-medium text-slate-500 uppercase tracking-wider">${state.varYName}</th><th rowspan="2" class="px-6 py-1 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">Total</th></tr><tr class="bg-slate-50">`;
        state.catYNames.forEach(name => {
            headHtml += `<th class="px-6 py-1 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">${name}</th>`;
        });
        headHtml += `</tr>`;
        head.innerHTML = headHtml;

        let bodyHtml = '';
        for (let i = 0; i < state.R; i++) {
            const rowTotal = stats.Ri[i];
            bodyHtml += `<tr class="bg-white"><td rowspan="3" class="px-6 py-1 font-medium text-slate-900 align-top">${state.catXNames[i]}</td>
                         <td class="px-6 py-1 text-slate-500">Observasi</td>`;
            for (let j = 0; j < state.C; j++) {
                bodyHtml += `<td class="px-6 py-1 text-right">${stats.O[i][j]}</td>`;
            }
            bodyHtml += `<td class="px-6 py-1 text-right font-medium">${rowTotal}</td></tr>`;

            bodyHtml += `<tr class="bg-white"><td class="px-6 py-1 text-slate-500">Harapan</td>`;
            for (let j = 0; j < state.C; j++) {
                bodyHtml += `<td class="px-6 py-1 text-right">${stats.E[i][j].toFixed(1)}</td>`;
            }
            bodyHtml += `<td class="px-6 py-1 text-right font-medium">${rowTotal.toFixed(1)}</td></tr>`;
            
            bodyHtml += `<tr class="border-b border-slate-300"><td class="px-6 py-1 text-slate-500">% dalam ${state.varXName}</td>`;
            for (let j = 0; j < state.C; j++) {
                const percent = rowTotal > 0 ? (stats.O[i][j] / rowTotal * 100).toFixed(1) + '%' : '0.0%';
                bodyHtml += `<td class="px-6 py-1 text-right">${percent}</td>`;
            }
            bodyHtml += `<td class="px-6 py-1 text-right font-medium">100.0%</td></tr>`;
        }
        bodyHtml += `<tr class="bg-slate-100 font-bold border-t-2 border-slate-400"><td colspan="2" class="px-6 py-1 text-left">Total Kolom</td>`;
        stats.Cj.forEach(total => {
             bodyHtml += `<td class="px-6 py-1 text-right">${total}</td>`;
        });
        bodyHtml += `<td class="px-6 py-1 text-right">${stats.N}</td></tr>`;
        body.innerHTML = bodyHtml;
        
        // Render interpretasi
        renderCrosstabInterpretation(stats);
    };

    const renderDetailedTable = (stats) => {
        const body = document.getElementById('detailed-tests-body');
        if (!stats || stats.N === 0) { body.innerHTML = ''; return; }

        let bodyHtml = `<tr>
            <td class="px-6 py-1 whitespace-nowrap font-medium text-slate-700">Pearson Chi-Square</td>
            <td class="px-6 py-1 whitespace-nowrap text-right">${stats.chiSquare.toFixed(3)}</td>
            <td class="px-6 py-1 whitespace-nowrap text-right">${stats.df}</td>
            <td class="px-6 py-1 whitespace-nowrap text-right">${formatPValue(stats.pValue)}</td>
            <td class="px-6 py-1 whitespace-nowrap text-right">-</td>
        </tr>`;
        
        // Baris Likelihood Ratio
        bodyHtml += `<tr class="bg-white">
            <td class="px-6 py-1 whitespace-nowrap font-medium text-slate-700">Likelihood Ratio</td>
            <td class="px-6 py-1 whitespace-nowrap text-right">${stats.likelihoodRatio.toFixed(3)}</td>
            <td class="px-6 py-1 whitespace-nowrap text-right">${stats.df}</td>
            <td class="px-6 py-1 whitespace-nowrap text-right">${formatPValue(stats.lrPValue)}</td>
            <td class="px-6 py-1 whitespace-nowrap text-right">-</td>
        </tr>`;

        if (state.R === 2 && state.C === 2) {
             bodyHtml += `<tr class="bg-slate-50">
                <td class="px-6 py-1 whitespace-nowrap font-medium text-slate-700">Continuity Correction</td>
                <td class="px-6 py-1 whitespace-nowrap text-right">${stats.ccChiSquare.toFixed(3)}</td>
                <td class="px-6 py-1 whitespace-nowrap text-right">1</td>
                <td class="px-6 py-1 whitespace-nowrap text-right">${formatPValue(stats.ccPValue)}</td>
                <td class="px-6 py-1 whitespace-nowrap text-right">-</td>
            </tr>`;
             bodyHtml += `<tr class="bg-white">
                <td class="px-6 py-1 whitespace-nowrap font-medium text-slate-700">Fisher's Exact Test</td>
                <td class="px-6 py-1 whitespace-nowrap text-right">-</td>
                <td class="px-6 py-1 whitespace-nowrap text-right">-</td>
                <td class="px-6 py-1 whitespace-nowrap text-right">-</td>
                <td class="px-6 py-1 whitespace-nowrap text-right">${formatPValue(stats.fisherP.twoSided)}</td>
            </tr>`;
        }
        
        bodyHtml += `<tr class="bg-green-50 font-bold">
            <td class="px-6 py-1 whitespace-nowrap text-green-800">N of Valid Cases</td>
            <td class="px-6 py-1 whitespace-nowrap text-right text-green-800" colspan="4">${stats.N}</td>
        </tr>`;
        body.innerHTML = bodyHtml;
    };

    const renderChart = (stats) => {
        const ctx = document.getElementById('chiSquareChart').getContext('2d');
        if (!stats || stats.N === 0) { if (chiSquareChart) chiSquareChart.destroy(); return; }

        const datasets = state.catYNames.map((name, j) => {
            return {
                label: name,
                data: state.catXNames.map((_, i) => stats.O[i][j]),
                backgroundColor: ['#34d399', '#fbbf24', '#60a5fa', '#f87171'][j % 4],
                borderColor: ['#059669', '#d97706', '#2563eb', '#dc2626'][j % 4],
                borderWidth: 1
            };
        });

        if (chiSquareChart) {
            chiSquareChart.data.labels = state.catXNames;
            chiSquareChart.data.datasets = datasets;
            chiSquareChart.update();
        } else {
            chiSquareChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: state.catXNames,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed.y !== null) {
                                        const total = context.chart.data.datasets.reduce((sum, ds) => sum + ds.data[context.dataIndex], 0);
                                        const percentage = total > 0 ? (context.parsed.y / total * 100).toFixed(1) + '%' : '0.0%';
                                        label += `${context.parsed.y} (${percentage})`;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { stacked: true, grid: { display: false } },
                        y: { stacked: true, beginAtZero: true, title: { display: true, text: 'Jumlah Frekuensi' } }
                    }
                }
            });
        }
    };
    
    const renderAll = () => {
        
        const stats = calculateStatistics();
        
        // Tentukan apakah ada data (N > 0)
        const hasData = stats.N > 0;
        
        // Tampilkan atau sembunyikan semua bagian hasil (2, 3, 4)
        const sections = [
            document.getElementById('crosstab-section'), 
            document.getElementById('detailed-tests-section'), 
            document.getElementById('analysis-dashboard-section')
        ];
        
        sections.forEach(sec => {
            if (hasData) {
                sec.classList.remove('hidden');
            } else {
                sec.classList.add('hidden');
            }
        });

        renderResults(stats);
        renderCrosstab(stats);
        renderDetailedTable(stats);
        renderChart(stats);
    };

    document.addEventListener('DOMContentLoaded', () => {
        // Atur state awal dan setup listener utama
        state.catXNames = Array(state.R).fill().map((_, i) => i < 2 ? (i === 0 ? "Kategori A" : "Kategori B") : `Kategori ${i+1}`);
        state.catYNames = Array(state.C).fill().map((_, j) => j < 2 ? (j === 0 ? "Kategori C" : "Kategori D") : `Kategori ${j+1}`);
        state.catXCodes = Array(state.R).fill().map((_, i) => String(i));
        state.catYCodes = Array(state.C).fill().map((_, j) => String(j));

        setupListeners(); 
        handleDimensionChange(); // Panggil ini untuk inisialisasi awal DOM dan hasil
    });
    </script>
</body>
</html>
